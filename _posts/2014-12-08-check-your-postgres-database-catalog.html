---
layout: post
title: Check your Postgres database catalog integrity effortlessly in seconds
date: '2014-12-08T12:33:00.000+02:00'
author: Hossam Hammady
tags:
- database
- backup
- heroku
- postgres
modified_time: '2014-12-10T11:39:52.615+02:00'
blogger_id: tag:blogger.com,1999:blog-1427064072400819258.post-8889913502909482829
blogger_orig_url: http://blog.hammady.net/2014/12/check-your-postgres-database-catalog.html
---

<div dir="ltr" style="text-align: left;" trbidi="on"><div>Regular database backups is something no one can afford missing. If your database is inconsistent backups won't be produced successfully. A quick search on <a href="https://www.google.com/search?rls=en&amp;q=pg_dump+cannot+schema+oid&amp;ie=UTF-8&amp;oe=UTF-8#rls=en&amp;q=pg_dump+schema+with+oid+does+not+exist">pg_dump schema with oid does not exist</a> reveals a lot are suffering and cannot produce any backups. <br /><br /></div><div>Going through the <a href="http://www.postgresql.org/message-id/438C7027.904@aeccom.com" target="_blank">search results</a>, people suggest manually scanning the system catalog tables to identify inconsistencies. This is a tedious process and requires a lot of knowledge about the catalog structure.<br /><br />Fortunately, there is an open-source tool called&nbsp;<a href="https://github.com/EnterpriseDB/pg_catcheck" target="_blank">pg_catcheck</a>,&nbsp;which can detect these inconsistencies. However, it requires you to install <a href="http://github.com/postgres/postgres" target="_blank">Postgres</a> from source and build the tool against its source tree, which may be <a href="https://groups.google.com/a/enterprisedb.com/forum/#!topic/pg-catcheck/ufIMq8XTpjs" target="_blank">tricky</a> on some systems. In this blog, I will introduce a cloud-based solution to effortlessly run pg_catcheck, without any compilation, at no extra cost.</div><span class="fullpost"> <a href="https://github.com/hammady/cloud_pg_catcheck" target="_blank">Cloud pg_catcheck</a> is a <a href="http://www.heroku.com/" target="_blank">heroku</a> customized fork of the original repo. There are 2 main advantages to use it over the local one:<br /><br /></span><br /><ol style="text-align: left;"><span class="fullpost"><li>No need to download, compile postgres or pg_catcheck from source.</li><li>For postgres servers running on heroku (or any AWS-based servers), super fast running time because it runs on the same infrastructure of the database server, reducing the time to do the check from minutes to several seconds.</li></span></ol><span class="fullpost">Fortunately, heroku gives <a href="https://devcenter.heroku.com/articles/usage-and-billing" target="_blank">free 750 dyno hours</a> per month, so you will always do the checks for free, because there are no web dynos running.<br /><br /></span><br /><h2 style="text-align: left;"><span class="fullpost">How to use:</span></h2><span class="fullpost">To check your own database, just clone this repo, deploy it to heroku, set database url and finally run the check:<br /><br />&nbsp;<code># setup: do this only once</code><br /><code>git clone https://github.com/hammady/pg_catcheck.git</code><br /><code>cd pg_catcheck</code><br /><code>heroku create --buildpack https://github.com/ddollar/heroku-buildpack-multi.git</code><br /><code>git push heroku master</code><br /><code><br /></code><code># set the database url and run the check</code><br /><code>heroku config:set DATABASE_URL=postgres://username:password@host:port/databasename</code><br /><code>heroku run ./check</code><br /><br />Before deploying, you need to create an account on heroku, if you don't already have one.&nbsp;</span></div>