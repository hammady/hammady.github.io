---
layout: post
title: Writing Large-Scale iPhone Applications using Jiggy
date: '2008-09-30T04:47:00.005+02:00'
author: Hossam Hammady
tags:
- javascript
- jiggy
- iphone
modified_time: '2008-10-04T16:38:54.552+02:00'
blogger_id: tag:blogger.com,1999:blog-1427064072400819258.post-4841252995839516498
blogger_orig_url: http://blog.hammady.net/2008/09/writing-large-scale-iphone-applications.html
---

Developing for the <a href="http://www.apple.com/iphone/">iPhone</a> is the hype nowadays. However, one big obstacle that faces anyone who wish to write iPhone applications is learning <a href="http://developer.apple.com/documentation/Cocoa/Conceptual/ObjectiveC/Introduction/chapter_1_section_1.html">Objective-C</a>. After all, it is a high-level Object Oriented language. However, in my point of view, and for many people as well, the C family of languages is not suitable for application development. It is perfectly suited for writing system libraries and frameworks. This is because one should always take care of memory management, types and low level system calls.<br /><br />Thats why we are here, quoted from the <a href="http://www.jiggyapp.com/">Jiggy</a> official website:<br /><br /><blockquote><br /><h3>What is Jiggy?</h3><br />Simply put, Jiggy is the easiest way to create applications for the iPhone (or iPod Touch). With just Jiggy and a browser, you'll be able to write an awesome iPhone application in a matter of minutes. JiggyApps run natively on the iPhone, so there is no messing around with HTML and the limitations of Mobile Safari. At the same time, you don't need a compiler or even a Mac, because JiggyApps are written in JavaScript.<br /></blockquote><br /><br /><p>When you start writing an application with Jiggy you will find it very simple. However, as your application grows it will be so hard to maintain. Thats why I am writing the following guidelines, which if followed, will help you write large-scale, neat and maintainable Jiggy applications:<br /></p><br /><br /><span class="fullpost"><br /><ol><li><span style="font-size:85%;"><span style="font-size:130%;"><span style="font-weight: bold;">Don't use the Jiggy IDE, prepare your development environment around ssh.</span></span><br />If you already installed Jiggy on your iPhone, you will probably have noticed that there are 2 packages your are installing. First one is called Jiggy runtime. This is a set of dynamic-link libraries that encapsulate all native functionality. These are installed in the library path of the system (/usr/lib) and start with the prefix jiggy, as an example: jiggy.UIKit and jiggy.sqlite. The other package is called just Jiggy. This is the Jiggy IDE I am talking about. It is just an application server built on an HTTP server. You run it from SpringBoard, open a browser on your PC and point it to the iPhone IP to get the IDE working inside the browser. This is the simplest way to develop Jiggy applications. You only need a browser. Running into big applications, you will soon find that the browser is never meant to be a reliable IDE. It WILL crash more frequent than you expect. It will leak memory to the ground. It will freeze for seconds as you save and run the application. Moreover, to work on multiple files simultaneously, you have to open several tabs/windows. You can use this IDE as a fast boot but when you eventually develop seriously you need a more reliable environment. Install <a href="http://blog.psmxy.org/pkg-info/openssh/">OpenSSH</a> on the iPhone (but be careful if you need to <a href="http://blog.hammady.net/2008/06/only-idiots-change-their-iphone-root.html">change the root password</a>). Next, mount the iPhone filesystem using sshfs:<br /><code><br />sshfs root@IPHONE_IP /mount/point -o allow_other<br /></code><br />You can download sshfs from its <a href="http://fuse.sourceforge.net/sshfs.html">official site</a> or if you are using Debian/Ubuntu by:<br /><code><br />sudo apt-get install sshfs<br /></code><br />or if you are using Gnome use the menu Places/Connect to Server... and select server type as SSH. Write the iPhone IP and root as the username. A shortcut will be placed in Places and on the desktop. Either way, you can browse through /Applicatoins/ and point to your application folder then double click on any Javascript file to edit using your favorite editor. I personally use gedit or vim. Just a note, be sure the iPhone is mounted before editing the files or the editor may get confused and hangs.<br /></span></li><span style="font-size:85%;"><br /></span><li><span style="font-size:85%;"><span style="font-size:130%;"><span style="font-weight: bold;">Distribute required runtime libraries along with your applications, don't assume Jiggy runtime.</span></span><br />These can be found in /usr/lib as discussed earlier. During the installation process, don't copy the libraries in the system /usr/lib in order not to conflict versions. It is safer to leave them in the application directory. By the way, I didn't try leaving them in the application directory yet :) On the contrary, you may prefer to distribute the libraries through Jiggy runtime. However, be very clear in the installation steps.<br /></span></li><span style="font-size:85%;"><br /></span><li><span style="font-size:85%;"><span style="font-size:130%;"><span style="font-weight: bold;">For a more stable and collaborative environment, use a code repository and deploy on device as needed. </span></span><br />When your code-base grows over time, you will discover that it is safer to use a code repostiory (<a href="http://subversion.tigris.org/">Subversion</a> of <a href="http://en.wikipedia.org/wiki/Concurrent_Versions_System">CVS</a>). This will also enable you to share the application with other developers. Now you don't have to mount the iPhone filesystem using ssh as you will not be editing files in-place. You will have a working copy on your PC which is linked against some repository. Each time you need to run the application you will have to copy files over the iPhone, you can write a small shell script to do the copy commands. Till the time of writing this line, Jiggy is only available for the iPhone OS 1.x which has no official SDK or emulator from <a href="http://www.apple.com/">Apple</a>. If Jiggy is ported to iPhone OS 2.x it would be easier to run applications on the emulator without the need of copying files on each run.</span></li><span style="font-size:85%;"><br /></span><li><span style="font-size:85%;"><span style="font-size:130%;"><span style="font-weight: bold;">Avoid using off-the-shelf libraries (<a href="http://www.prototypejs.org/">prototype</a> for example), you don't need larger useless interpretation times.<br /></span></span>Usually you won't need fancy mechanisms or drag-and-drop and alike functionality. If you need to use AJAX, write your own prototype-alike around the XMLHttpRequest object. If you are too lazy to write it, see <a href="http://downloads.hammady.net/jsexamples/jiggy/ajax.js">mine</a>.<br /></span></li><span style="font-size:85%;"><br /></span><li><span style="font-size:85%;"><span style="font-size:130%;"><span style="font-weight: bold;">Don't start the application from SpringBoard (if you don't have to). Start it from an ssh terminal instead</span></span>.<br />Some functionality won't work if you don't start the application from SpringBoard (like the accelerometer). If you don' have to, ssh to your iPhone and change to the applications directory then launch the jiggy binary:<br /><code><br />ssh root@IPHONE_IP<br />cd /Applications/MyApp.app<br />./jiggy<br /></code><br />This is a must if you need to see useful log messages from Jiggy native implementation. You can also write your own logs straight from Javascript using the global function log(). See my <a href="http://blog.hammady.net/2008/09/your-guide-to-writing-large-scale.html">other post</a> for a discussion on logging in Javascript platforms.<br /></span></li><span style="font-size:85%;"><br /></span><li><span style="font-size:85%;"><span style="font-size:130%;"><span style="font-weight: bold;">Optionally generate a public/private ssh key-pair so that you don't have to enter ssh password every time you login to your iPhone.</span></span><br />See the <a href="http://blog.psmxy.org/pkg-info/openssh/">OpenSSH page</a> or this <a href="http://rcsg-gsir.imsb-dsgi.nrc-cnrc.gc.ca/documents/internet/node31.html">good tutorial</a>.</span></li><span style="font-size:85%;"><br /></span><li><span style="font-size:85%;"><span style="font-size:130%;"><span style="font-weight: bold;">Keep your main.js as small as 10 lines or less. </span></span><br />This is always a rule-of-thumb for all programming paradigms. The general flow of the program should be readable by anybody. Throw away your implementations inside classes and throw these classes inside files other than your main.js. Even more, I do NOT write any flow in my main, its just a logic switch, or program selector:</span></li><span style="font-size:85%;"><br /><code><br />// main.js<br />try {<br />//include("test1.js")<br />//include("test2.js")<br />include("myprog1.js")<br />}<br />catch(e) {<br />log(e)<br />terminate()<br />}<br /></code><br />Whenever I need to test any code or run any sample code, I just throw it in a file and switch to it in my main. When I am finished I uncomment back the original program.<br />The try/catch is there to bust silly alerts that appears on-screen which if not dismissed normally by user, will freeze the SpringBoard.<br /><br /></span><li><span style="font-size:85%;"><span style="font-size:130%;"><span style="font-weight: bold;">Create a test-harness because you will need to try various things first.<br /></span></span>You may create a new application for the sole purpose of testing code. Create any testing code in new files and switch between them in main.js. This way you don't need new applications each time you try any code. See the code of main.js in previous point as an example.<br /></span></li><span style="font-size:85%;"><br /></span><li><span style="font-size:85%;"><span style="font-size:130%;"><span style="font-weight: bold;">Make your files self-contained, don't assume any implicit dependency.</span></span><br />In Jiggy, there are 2 types of code dependency. First is Plugin dependency where you depend on a native plugin (<a href="http://www.jiggyapp.com/jigglins">Jigglin</a>). Second type is Javascript dependency where you depend on other Javascript files. As an example for the first type, if you use the package <span style="font-style: italic;">Images</span> don't assume that the <span style="font-style: italic;">UIKit</span> plugin is loaded. In the beginning of the file check if it is not loaded and load it accordingly:<br /><code><br />if (typeof Images == 'undefined')<br />Plugins.load('UIKit')<br /></code><br />Current Jiggy implementation does not check for loading same plugins more than once, and hence the check above.<br />As an example for the second dependency type consider this:<br /><code><br />include('another.js')<br /></code><br />And in another.js put the inclusion guard which I borrow from C/C++!<br /><code><br />if (typeof __ANOTHER_JS == 'undefined') {<br />__ANOTHER_JS = 0<br />// write all your Javascript code here<br />...<br />}<br /></code><br /></span></li><span style="font-size:85%;">This inclusion guard is recommended although not mandatory because re-interpretation of code may cause undesired logical errors.<br /><br /></span><li><span style="font-size:85%;"><span style="font-size:130%;"><span style="font-weight: bold;">Use a central include path because you are going to make/use reusable components. </span></span><br />Sticking to the Object Oriented design will render many parts of your code reusable. The straightforward way to reuse the components is to copy them over through different applications. However, you will be changing them frequently and you need a central place for them. You may place them in a separate directory and create symbolic links inside your application folder. I wish I could have time to patch Jiggy source so that it looks in a central include path if it does not find the file in the application directory. Did I hear someone offering help?<br /></span></li><span style="font-size:85%;"><br /></span><li><span style="font-size:85%;"><span style="font-size:130%;"><span style="font-weight: bold;">Always remember the restricted memory resources, cache on disk if necessary.</span></span><br />Don't write code that aggressively allocates memory. Don't let your arrays grow indefinitely. If you need large data-structures let them write their data on disk if they exceeded some limit, using sqlite if needed. If it is all about memory cache, let older values drop altogether.</span></li><span style="font-size:85%;"><br /></span><li><span style="font-size:85%;"><span style="font-size:130%;"><span style="font-weight: bold;">Don't forget your friend, the garbage collector (GC), you may know when to call it better than the engine does.</span></span><br />Let the code be smart and invoke it in places where you are sure many objects have been released. Each time you release an object, or return from a function, increment released objects count and invoke the GC if it reached some limit. The <a href="http://downloads.hammady.net/jsexamples/jiggy/">AutoReleaseCache and ImageLoader</a> are perfect examples for restricted memory management and garbage collection. There should be a global GC function when using them. Here it is:<br /><code><br />var GC_TRIGGER = 40<br />var releasedObjectsCount = 0<br />GC = function(force)<br />{<br />if (force || releasedObjectsCount++ > GC_TRIGGER) {<br />releasedObjectsCount = 0<br />log("-----------------------------------------------")<br />log("running gc")<br />log("-----------------------------------------------")<br />gc(1)<br />}<br />}<br /></code><br /></span></li></ol><br /></span>